<!DOCTYPE html>
<html>
<head>
  <%= wicked_pdf_stylesheet_link_tag "tailwind" -%>
  <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <style>
      html, body
      {
          width: 210mm;
      }
      body
      {
          padding: 1.25cm;
      }
      .nobreak
      {
          page-break-inside: avoid;
      }
      .nobreak:before
      {
          clear:both;
      }
  </style>
</head>
  <body class="flex flex-col text-center">
    <div class="w-1/2 ml-auto pb-8">
      <div class="text-right pb-2">
        <span class="block font-bold">
          Data wygenerowania:
        </span>
        <span class="block">
          <%= DateTime.now.to_s %>
        </span>
      </div>
      <div class="text-right pb-2">
        <span class="block font-bold">
          SHA-256:
        </span>
        <span class="block">
          <% sha_str = Digest::SHA256.hexdigest @election.to_json %>
          <span><%= sha_str[0...32] %></span>
          <span><%= sha_str[32..-1] %></span>
        </span>
      </div>
    </div>

    <h1 ><b>Wyniki głosowania</b></h1>
    <h3><i><%= @election.name %></i></h3>

    <div>
      <% (1..5).each do |test| %>
        <% @election.election_sheets.each do |election_sheet| %>
          <% total_voters_eligible = election_sheet.election.users.distinct.count %>
          <% voters = election_sheet.election_sheet_user_votes.count %>
          <% total_votes_on_candidates = election_sheet.election_sheet_candidates.sum(:votes) %>
          <hr>
          <div class="nobreak my-5 relative bg-white  rounded-md flex flex-col justify-center gap-y-4">
            <h3 class="m-0 p-0"><b>Karta do głosowania</b></h3>

            <h4 class="m-0 p-0"><i><%= election_sheet.name %></i></h4>

            <p class="text-left"><%= election_sheet.description %></p>

            <span>Do wykorzystania: <span><%= election_sheet.max_votes_per_user %></span> głosów.</span><br/>
            <span>Maksymalna ilość głosów na kandydata: <span><%= election_sheet.max_votes_per_candidate %></span> głosów.</span><br/>
            <% if election_sheet.requires_all_votes_spent %>
              <span>Wymagane było wydanie wszystkich głosów</span><br/>
            <% end %>

            <span>
            Frekwencja w ramach tej karty wynosi:
            <b><%= number_to_percentage(100 * voters / total_voters_eligible.to_d, precision: 2) %></b><br/>
            Jest to <b><%= voters %></b> głosujących z <b><%= total_voters_eligible %></b> uprawnionych do głosowania
          </span>

            <div class="grid grid-cols-12 gap-y-2 gap-x-1">
              <div class="col-span-4 text-left font-bold pb-2">
                Kandydat
              </div>
              <div class="col-span-2 text-left font-bold pb-2">
                Głosy
              </div>
              <div class="col-span-6 text-left font-bold pb-2 text-center">
                Procent
              </div>
              <% election_sheet.election_sheet_candidates.order(votes: :desc).each do |candidate| %>
                <% percent = (100.0 * candidate.votes / total_votes_on_candidates).to_d %>
                <div class="col-span-4 text-left">
                  <%= candidate.name %>
                </div>
                <div class="col-span-2 text-left">
                  <%= candidate.votes %>
                </div>
                <div class="col-span-2 text-right">
                  <b class="text-right"><%= number_to_percentage(percent, precision: 2) %></b>
                </div>
                <div class="col-span-4 flex flex-row justify-start">
                  <div class="h-8 bg-green-100 border border-green-300 hover:bg-green-200 " style="width: <%= percent %>%"></div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
  </body>
</html>
